### 组播路由协议基础

- 我们已经知道，组播报文是由组播源产生并且发向一组接收者的，组播报文一旦进入组播网络后，组播网络设备(例如组播路由器等)负责拷贝及转发这些报文，直至报文到达接收者。那么组播路由器如何知道应该将组播报文转发到哪里 （从设备的哪个或者哪些接口转发出去）？组播报文在网络中的传输路径如何？如何确保组播报文在转发的过程中不存在环路？这就要用到组播路由协议了。
- 每一合组播路由器都维护一个非常重要的数据表，这个数据表便是组播路由表，组播路由表中包含的组播路由表项将用于指导组播报文转发。在一个组播网络中，组播路由协议的主要作用如下。
  - 在每合路由器上确定朝向组播源（或者 RP）的接口，该接口也被称为上游接口。在每合组播路由器的每一个组播路由表项中，如果存在上游接口，那么上游接口只会有一个，只有在该接口上到达的组播流量才被视为合法的。
  - 在每台路由器上确定朝向组播接收者的接口，该接口也被称为下游接口。当组播流量在上游接口到达时，组播路由器负责将流量从下游接口转发出去。需要强调的是，组播流量永远不会从上游接口转发出去，因为这有可能在网络中造成环路。在一个组播路由表项中，下游接口列表中可能包含零个、一个或多个接口。
  - 维护组播路由表项。每一个组播路由表项都以一对二元组 （组播源及组播组）进行标识，而且每一个组播路由表项都包含上游、下游接口信息。从宏观的层面看，组播路由协议的工作成果是在网络中构建一棵无环的“树”，组播流量沿着这棵无环树从上游向下游转发，最终到达接收者所在的网段，而网络中的每一合组播路由器，便是这棵树上的节点。

<br>
<br>


### 12.5.1 组播分发栵
- 在一个组播网络中，组播路由协议扮演着非常关键的角色。组播路由协议最重要的工作之一就是为组播网络生成一棵无环的树，这棵树也是组播流量在网络中的传输路径，我们称之为组播分发树 (Multicast Distribution Tree)，简称为组播树。常用的组播分发树有以下两种。
- SPT (Shortest-Path Tree，最短路径树）
  - SPT 也被称为源树，是以组播源为树根的组播分发树，而组播组的接收者则可以看作是这棵树的树叶。组播流量从树根（源）出发，沿着枝干传播，最终到达树叶，也即按收者所在的终端网络，如图 12-24 所示。
  ![12.24](../pics/12.24.png)
  - 实际上图 12-24 所描绘的组播分发树仅是一个形象化的概念，对于组播网络中的每一合路由器而言，它们并不清楚 “整棵树〞 的完整形态，组播分发树体现到每一合组播路由器上其实就是组播路由表中的相关表项。每一台组播路由器都维护着组播路由表，该数据表用于指导组播流量转发。在实际的网络中，组播路由表可能包含多个表项，每个表项都存在四个关键信息：组播源地址、组播组地址、上游接口以及下游接口。
  - 组播路由表项分为两种类型：(S，G)和（\*，G)。其中s 表示具体的某个组播源 IP 地址，G 表示具体的某个组播组 IP 地址，而 \* 则表示任意的组播源。
  - 对于 SPT 而言，使用的是（S，G）表项，每一个(S，G)表项在网络中都对应了一棵独立的 SPT。以图 12-24 为例，当SPT 建立完成后，我们就能在每合路由器上观察到（S，G） 表项，其中S 为组播源的 IP 地址，例如图 12-24 中的 10.1.1.1，假设该组播源向组播组 239.1.1.13 发送组播流量，那么网络中组播路由器所维护的 (S，G) 表项就是 (10.1.1.1，239.1.1.13)。每合路由器的(10.1.1.1，239.1.1.13) 表项都包含上游及下游接口信息，在 SPT 中，上游接口是设备朝向组播源的接口，例如在 R3 的 (10.1.1.1， 239.1.1.13) 表项中，上游接口是其连接 R1 的接口，而下游接口有三个，分别是其连接 R5、R6 以及直连网段中存在组成员的那个接口。当 R3 从上游接口收到 10.1.1.1 发往 239.1.1.13 的组播流量时，就会将这些流量按照 (10.1.1.1， 239.1.1.13）)表项的指示，拷贝三份并分别从三个下游接口转发出去，因此形象的理解就是：这些组播流量沿着 SPT 转发了下去。
  - 对于 SPT 而言，组播流量从源到接收者的过程走的是最短路径，这也是该组播分发树被称为最短路径树的原因。然而由于 SPT 使用的组播路由表项是 (S，G) 表项，这意味着每合组播路由器都不得不为每个组播组中的不同组播源创建单独的（S，G）表项，在一个大型的组播网络中，当存在大量的组播源及组播组时，路由器的内存空问将被臃肿的组播路由表占据，进而导致性能下降。
- 2. RPT (Rendezvous Point Tree，共享树)
  - RPT 与 SPT 不同，它不以组播源为树根，而是以 RP (Rendezvous Point）为根。RP类似于一个汇聚点的概念，在一个典型的组播网络中，通常是一合性能较好的网络设备。
多个组播组可以共用一个 RP，期望接收组播流量的路由器通过组播路由协议在自己与 RP 之间建立一段 RPT 的分支。组播流量首先需要从源发送到RP，然后再由 RP 将组播流量分发下来，组播流量顺着 RPT 最终到达各个接收者所在的终端网络，如图 12-25 所示。在本例中，组播源 Source 与 RP 之间建立了 SPT， Source 通过这棵 SPT 将组播流量发送到RP，而RP 再将组播流量沿着 RPT转发到组播接收者。
  - RPT 主要使用的是（\*，G)表项，其中“\*表示的是任意的组播源。换句话说，对于 RPT 而言，路由器对于每个组播组仅需维护一个（*，G）组播路由表项，无论有多少个组播源在向该组播组发送组播流量。
  - 由于在网络中指定了 RP，组播流量需要先从源发往 RP，再由 RP 沿着组播树分发下来，这就势必存在这样一种情况：对于某些接收者而言，组播流量传输的路径可能并不是最优路径，如图12-25中，组播流量从 Source 转发到 RP，再由 RP 转发到 R2，显然对于 R2 而言这条路径并非最优，这就有可能引入额外的时延。当然，组播路由协议也有相应的机制来规避这种次优路径问题。
  ![12.25](../pics/12.25.png)

<br>
<br>

### 认识组播相关表项
- 对于组播而言，有几个数据表是大家需要熟悉和理解的。它们分别是 IGMP 组表、IGIMP 路由表、组播协议路由表、组播路由表及组播转发表。在深入讲解组播之前，学会读懂这几张数据表并掌握相应的查看方法是非常有必要的。
- IGMP 组表
  - 一旦设备在某个接口上激活了 IGMP，该设备就会开始维护 IGMP 组表。初始情况下该数据表是空的，当设备在接口上收到直连网段中的主机发送出来的IGMP 成员关系报告时，设备就会在 IGMP 组表中创建一个新的表项。以图 12-26 为例:
  ![12.26](../pics/12.26.png)
  - 我们在 R3 的 e0/2 接口上激活了 IGMPV2，现在 PC1 发送 IGMPv2 成员关系报告以宣告自己加入组播组 224.0.1.40，R3 在 e0/2 接口上收到该报文后，将会创建如下表项:
  ```shell
  R3#show ip igmp groups 
  IGMP Connected Group Membership
  Group Address    Interface                Uptime    Expires   Last Reporter   Group Accounted
  224.0.1.40       Ethernet0/2              00:00:04  00:02:57  192.168.1.254   
  ```
  - 设备将其通过 IGMP 协议发现的组播组以及该组中最近一次发送成员关系报告的成员I地址记录在该表中。
- IGMP 路由表
  - 对于最后一跳路由器而言，通常有接口直连着存在组播成员的终端网络，而这个接口并不一定需要激活组播路由协议(例如 PIM)，但是一般必须激活 IGMP。如果路由器的接口没有激活组播路由协议，那么协议将无法把这个接口识别为组播协议路由表项的下游接口，这样一来就需要使用 IGMP 路由表中的接口信息作为组播路由表项的下游接口的扩展。使用 display igmp routing-table 命令可以查看设备的IGMP路由表，如图 12-26